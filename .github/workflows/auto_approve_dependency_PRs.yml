name: Auto Approve Dependency PRs
on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches:
      - main 
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Find dependency PRs
        id: find_prs
        run: |
          gh pr list --repo "alteryx/woodwork" --author "machineFL" --base main --state open --search "status:success review:required" --limit 1 --json url > dep_PRs_waiting_approval.json
          cat dep_PRs_waiting_approval.json
          echo $(cat dep_PRs_waiting_approval.json | grep -Eo "(https)://[a-zA-Z0-9./?=_%:-]*")
          echo ::set-output name=dep_pull_request_url::$(cat dep_PRs_waiting_approval.json | grep -Eo "(https)://[a-zA-Z0-9./?=_%:-]*")
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_SCOPED_TOKEN }}
      - name: Approve dependency PRs and enable auto-merge
        run: | 
          echo "${{ steps.find_prs.outputs.dep_pull_request_url }}"
          if [[ "${{ steps.find_prs.outputs.dep_pull_request_url }}" -gt 8 ]]; then
              gh pr review ${{ steps.find_prs.outputs.dep_pull_request_url }} --approve --comment --body "auto approve"
              gh pr merge ${{ steps.find_prs.outputs.dep_pull_request_url }} --auto --squash
          else 
            echo No matching PR found;
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.AUTO_APPROVE_TOKEN }}
